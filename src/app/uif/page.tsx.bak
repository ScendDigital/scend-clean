"use client";
import React, { useMemo, useState } from "react";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * UIF estimator with:
 * - Claim type dropdown + per-type document tips
 * - Sliding scale (38–60%) for the first 0–238 days; 20% for days 239–365
 * - Claim-type maximum payable days
 * - DoL downtime warning (nights/weekends)
 * - Official + mirror links
 * - Share buttons + PDF export + Print
 */

type ClaimType =
  | "unemployment"
  | "maternity"
  | "parental"
  | "adoption"
  | "illness"
  | "reduced"
  | "dependants";

const UIF_MONTHLY_CEILING = 17712; // R per month cap
const SLIDING_MAX_DAYS = 238;      // days on IRR sliding scale
const GLOBAL_MAX_CREDIT_DAYS = 365;

const CLAIM_LIMITS: Record<ClaimType, { label: string; maxDays: number; notes?: string }> = {
  unemployment: { label: "Unemployment", maxDays: 365, notes: "Days 0–238 at sliding rate; 239–365 at 20%." },
  maternity:    { label: "Maternity",    maxDays: 121, notes: "Typical max ~4 months (≈121 work days)." },
  parental:     { label: "Parental",     maxDays: 10,  notes: "Statutory ~10 consecutive work days." },
  adoption:     { label: "Adoption",     maxDays: 50,  notes: "Typical ~10 weeks (≈50 work days)." },
  illness:      { label: "Illness",      maxDays: 238, notes: "Often up to 238 work days with medical proof." },
  reduced:      { label: "Reduced Work Time", maxDays: 365, notes: "Paid for lost hours; depends on verified short time." },
  dependants:   { label: "Dependants (death claim)", maxDays: 365, notes: "Paid to dependants; credits cap applies." },
};

// Extra documents per claim type (guidance, not exhaustive)
const CLAIM_DOCS: Record<ClaimType, string[]> = {
  unemployment: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Unemployment Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped by bank)",
    "Copy of ID / Passport",
    "Proof of termination (dismissal/retrenchment letter) if available",
  ],
  maternity: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped)",
    "Medical certificate/Proof of birth (when available)",
    "Copy of ID / Passport",
  ],
  parental: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped)",
    "Child's birth certificate",
    "Proof of parental leave from employer (if available)",
  ],
  adoption: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped)",
    "Adoption court order / placement letter",
  ],
  illness: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped)",
    "Recent medical certificate (original; not older than 14 days when applicable)",
  ],
  reduced: [
    "UI-19 — Employer Declaration",
    "UI-2.1 — Application for Benefits",
    "UI-2.7 — Employer Certificate",
    "UI-2.8 — Banking Details (stamped)",
    "Proof of reduced hours/short-time from employer",
    "Recent payslips showing reduced earnings",
  ],
  dependants: [
    "UI-2.1 — Application for Benefits (as dependant)",
    "UI-2.8 — Banking Details (stamped)",
    "Deceased’s death certificate",
    "Deceased’s ID copy",
    "Proof of relationship (marriage/birth certificate, affidavit where applicable)",
  ],
};

function clamp(n: number, min: number, max: number) { return Math.min(Math.max(n, min), max); }
function round2(n: number) { return Math.round(n * 100) / 100; }
function fmtMoney(n: number) { return n.toLocaleString("en-ZA", { style: "currency", currency: "ZAR", maximumFractionDigits: 2 }); }

export default function UifPage() {
  const [claimType, setClaimType] = useState<ClaimType>("unemployment");
  const [salary, setSalary] = useState("");
  const [monthsWorked, setMonthsWorked] = useState("");
  const [result, setResult] = useState<null | {
    cappedSalary: number;
    dailyIncome: number;
    irrPct: number;
    dailyBenefitSliding: number;
    dailyBenefitFlat20: number;
    creditDays: number;
    daysSliding: number;
    daysFlat20: number;
    totalBenefit: number;
    estMonths: number;
  }>(null);

  // Off-hours detection: Nights (20:00–06:59) or Weekends (Sat/Sun)
  const showDowntimeWarning = useMemo(() => {
    const now = new Date();
    const day = now.getDay(); // 0=Sun, 6=Sat
    const hr = now.getHours();
    const isWeekend = day === 0 || day === 6;
    const isNight   = hr >= 20 || hr < 7;
    return isWeekend || isNight;
  }, []);

  function computeBenefit(avgMonthly: number, months: number, type: ClaimType) {
    const limits = CLAIM_LIMITS[type];

    const cappedSalary = Math.min(Math.max(avgMonthly, 0), UIF_MONTHLY_CEILING);
    const Y1 = (cappedSalary * 12) / 365;

    const irrRaw = 29.2 + 7173.92 / (232.92 + Y1);
    const irrPct = clamp(irrRaw, 38, 60);

    const dailySliding = (irrPct / 100) * Y1; // first 0–238 days
    const dailyFlat20  = Y1 * 0.20;           // days 239–365

    const approxCredits = Math.floor((months * 30) / 4);
    const creditDays = clamp(approxCredits, 0, Math.min(GLOBAL_MAX_CREDIT_DAYS, limits.maxDays));

    const daysSliding = clamp(creditDays, 0, SLIDING_MAX_DAYS);
    const daysFlat20 = creditDays > SLIDING_MAX_DAYS ? creditDays - SLIDING_MAX_DAYS : 0;

    const totalSliding = dailySliding * daysSliding;
    const totalFlat = dailyFlat20 * daysFlat20;
    const totalBenefit = totalSliding + totalFlat;

    const estMonths = creditDays > 0 ? creditDays / 21.67 : 0;

    return {
      cappedSalary,
      dailyIncome: round2(Y1),
      irrPct: round2(irrPct),
      dailyBenefitSliding: round2(dailySliding),
      dailyBenefitFlat20: round2(dailyFlat20),
      creditDays,
      daysSliding,
      daysFlat20,
      totalBenefit: round2(totalBenefit),
      estMonths: round2(estMonths),
    };
  }

  const calculate = () => {
    const sal = parseFloat(salary) || 0;
    const months = parseFloat(monthsWorked) || 0;
    if (sal <= 0 || months <= 0) { setResult(null); return; }
    setResult(computeBenefit(sal, months, claimType));
  };

  const clear = () => {
    setSalary("");
    setMonthsWorked("");
    setResult(null);
  };

  function shareSummary() {
    if (!result) return "UIF result: Enter inputs and click Calculate.";
    const t = CLAIM_LIMITS[claimType]?.label ?? "UIF";
    const base = [
      `${t} UIF Estimate`,
      `Salary used (cap): ${fmtMoney(result.cappedSalary)}`,
      `IRR: ${result.irrPct}%`,
      `Daily benefit: ${fmtMoney(result.dailyBenefitSliding)} (sliding) / ${fmtMoney(result.dailyBenefitFlat20)} (20% band)`,
      `Credit days: ${result.creditDays} (sliding ${result.daysSliding}, flat20 ${result.daysFlat20})`,
      `Months payable: ${result.estMonths}`,
      `Total estimated: ${fmtMoney(result.totalBenefit)}`
    ];
    return base.join(" • ");
  }
  function waShare() {
    if (!result) { alert("Calculate first, then share."); return; }
    const text = encodeURIComponent(shareSummary() + " — " + (typeof window !== "undefined" ? window.location.href : ""));
    window.open(`https://wa.me/?text=${text}`, "_blank");
  }
  function emailShare() {
    if (!result) { alert("Calculate first, then share."); return; }
    const subject = encodeURIComponent("UIF estimate");
    const body = encodeURIComponent(shareSummary() + "\n\n" + (typeof window !== "undefined" ? window.location.href : ""));
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }
  async function copyShare() {
    if (!result) { alert("Calculate first, then copy."); return; }
    try { await navigator.clipboard.writeText(shareSummary() + " — " + (typeof window !== "undefined" ? window.location.href : "")); alert("Copied to clipboard"); }
    catch { alert("Copy failed"); }
  }

  function exportPDF() {
    if (!result) return;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("Scend — UIF Benefit Estimate", 14, 16);
    doc.setFontSize(10);
    doc.text(`Claim type: ${CLAIM_LIMITS[claimType].label}`, 14, 23);

    const rows: any[] = [
      ["Salary used (cap)", fmtMoney(result.cappedSalary)],
      ["Daily income (Y1)", fmtMoney(result.dailyIncome)],
      ["IRR (sliding rate)", `${result.irrPct}%`],
      ["Daily benefit (sliding)", fmtMoney(result.dailyBenefitSliding)],
      ["Daily benefit (20% band)", fmtMoney(result.dailyBenefitFlat20)],
      ["Credit days (total)", String(result.creditDays)],
      ["— Sliding scale days (0–238)", String(result.daysSliding)],
      ["— Flat 20% days (239–365)", String(result.daysFlat20)],
      ["Estimated months payable", String(result.estMonths)],
      ["Total estimated benefit", fmtMoney(result.totalBenefit)]
    ];

    autoTable(doc, { startY: 30, head: [["Field","Value"]], body: rows, styles: { fontSize: 10 }, theme: "grid", margin: { left: 14, right: 14 } });

    const disclaimer =
      "Indicative only — not advice. The Department of Employment and Labour/UIF have final say. " +
      "Rules may vary by claim type and verification. If official links time out, use mirror downloads.";
    const pageWidth = doc.internal.pageSize.getWidth();
    const footerY = doc.internal.pageSize.getHeight() - 12;
    doc.setFontSize(8);
    doc.text(disclaimer, 14, footerY, { maxWidth: pageWidth - 28 });

    doc.save("UIF_Estimate.pdf");
  }

  function printPage() {
    window.print();
  }

  const btnPrimary = "rounded-xl px-4 py-2 bg-pink-600 text-white hover:opacity-90";
  const btnOutline = "rounded-xl px-3 py-2 border";

  return (
    <section className="mx-auto max-w-4xl p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">UIF Tool</h1>
          <p className="text-sm text-gray-600">
            Estimate your UIF benefit and find the official forms and steps for claiming.
          </p>
        </div>
        <div className="hidden md:flex flex-wrap gap-2">
          <button className={btnOutline} onClick={waShare} disabled={!result}>Share WhatsApp</button>
          <button className={btnOutline} onClick={emailShare} disabled={!result}>Share Email</button>
          <button className={btnOutline} onClick={copyShare} disabled={!result}>Copy</button>
          <button className={btnOutline} onClick={exportPDF} disabled={!result}>Export PDF</button>
          <button className={btnOutline} onClick={printPage}>Print</button>
        </div>
      </div>

      {showDowntimeWarning && (
        <div className="rounded-xl border border-amber-300 bg-amber-50 text-amber-900 p-3 text-sm">
          <b>Heads up:</b> The Department of Employment and Labour site often experiences downtime
          at night and on weekends. If an official link times out, use the <b>Mirror download</b> next to it.
        </div>
      )}

      <div className="rounded-xl border bg-white shadow-sm p-4 space-y-4">
        <div>
          <label className="block text-sm font-medium">What are you claiming for?</label>
          <select
            className="border rounded-md px-3 py-2 w-full md:w-80"
            value={claimType}
            onChange={e => { setClaimType(e.target.value as ClaimType); setResult(null); }}
          >
            {Object.entries(CLAIM_LIMITS).map(([k, v]) => (
              <option key={k} value={k}>{v.label}</option>
            ))}
          </select>
          {CLAIM_LIMITS[claimType]?.notes && (
            <p className="text-xs text-gray-500 mt-1">{CLAIM_LIMITS[claimType].notes}</p>
          )}
          <div className="mt-2 rounded-lg border border-pink-200 bg-pink-50 p-3">
            <p className="text-xs text-pink-800 mb-1">
              Typical supporting documents for <b>{CLAIM_LIMITS[claimType].label}</b> (check DoL/uFiling for updates):
            </p>
            <ul className="list-disc list-inside text-xs text-pink-900 space-y-0.5">
              {CLAIM_DOCS[claimType].map((d, i) => <li key={i}>{d}</li>)}
            </ul>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium">Average Monthly Salary (R)</label>
          <input
            type="number"
            value={salary}
            onChange={(e) => setSalary(e.target.value)}
            className="border rounded-md px-3 py-2 w-60"
            placeholder="e.g. 12000"
          />
          <p className="text-xs text-gray-500 mt-1">Capped at {fmtMoney(UIF_MONTHLY_CEILING)} for UIF calculations.</p>
        </div>

        <div>
          <label className="block text-sm font-medium">Months Worked in the Last 4 Years</label>
          <input
            type="number"
            value={monthsWorked}
            onChange={(e) => setMonthsWorked(e.target.value)}
            className="border rounded-md px-3 py-2 w-60"
            placeholder="e.g. 24"
          />
          <p className="text-xs text-gray-500 mt-1">
            Credits accrue at roughly 1 day for every 4 days worked (≈7–8 per month).
          </p>
        </div>

        <div className="flex flex-wrap gap-3">
          <button onClick={calculate} className={btnPrimary}>Calculate</button>
          <button onClick={clear} className="rounded-xl px-4 py-2 border">Clear</button>

          <div className="flex gap-2 md:hidden">
            <button className={btnOutline} onClick={waShare} disabled={!result}>WhatsApp</button>
            <button className={btnOutline} onClick={emailShare} disabled={!result}>Email</button>
            <button className={btnOutline} onClick={copyShare} disabled={!result}>Copy</button>
            <button className={btnOutline} onClick={exportPDF} disabled={!result}>PDF</button>
            <button className={btnOutline} onClick={printPage}>Print</button>
          </div>
        </div>
      </div>

      <div className="rounded-xl border bg-white shadow-sm">
        <div className="px-5 py-4 border-b">
          <h2 className="font-semibold">Results</h2>
        </div>
        <div className="px-5 py-4">
          {result ? (
            <div className="grid gap-2">
              <div className="flex justify-between"><span>Claim type</span><b>{CLAIM_LIMITS[claimType].label}</b></div>
              <div className="flex justify-between"><span>Salary used (cap)</span><b>{fmtMoney(result.cappedSalary)}</b></div>
              <div className="flex justify-between"><span>Daily income (Y1)</span><b>{fmtMoney(result.dailyIncome)}</b></div>
              <div className="flex justify-between"><span>IRR (sliding rate)</span><b>{result.irrPct}%</b></div>
              <div className="flex justify-between"><span>Daily benefit (first {SLIDING_MAX_DAYS} days)</span><b>{fmtMoney(result.dailyBenefitSliding)}</b></div>
              <div className="flex justify-between"><span>Daily benefit (days 239–365)</span><b>{fmtMoney(result.dailyBenefitFlat20)}</b></div>
              <div className="flex justify-between"><span>Total credit days (capped)</span><b>{result.creditDays}</b></div>
              <div className="flex justify-between"><span>— Sliding-scale days</span><b>{result.daysSliding}</b></div>
              <div className="flex justify-between"><span>— Flat 20% days</span><b>{result.daysFlat20}</b></div>
              <div className="flex justify-between"><span>Estimated months payable</span><b>{result.estMonths}</b></div>
              <div className="flex justify-between"><span>Total UIF benefit (estimate)</span><b>{fmtMoney(result.totalBenefit)}</b></div>
              <p className="text-xs text-gray-500 mt-2">
                Timing and validation can affect totals. For Reduced Work Time, actual payouts depend on verified lost hours.
              </p>
            </div>
          ) : (
            <p className="text-sm text-gray-600">Enter inputs and click <b>Calculate</b> to see results.</p>
          )}
        </div>
      </div>

      <div className="border rounded-xl bg-white shadow-sm p-4 space-y-2">
        <h3 className="font-semibold">Required UIF Forms & Resources</h3>
        <p className="text-xs text-gray-500 -mt-1 mb-1">
          Government servers can be slow. If an official link times out, use the <b>Mirror download</b> hosted on this site.
        </p>
        <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
          <li>
            <a href="https://www.labour.gov.za/DocumentCenter/Forms/Unemployment%20Insurance%20Fund/UI-19.pdf" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              UI-19 — Employer Declaration Form (official)
            </a>
            <span className="mx-2 text-gray-400">•</span>
            <a href="/uif/forms/UI-19.pdf" download className="text-pink-600 underline">Mirror download</a>
          </li>
          <li>
            <a href="https://www.labour.gov.za/DocumentCenter/Forms/Unemployment%20Insurance%20Fund/UI-2.8.pdf" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              UI-2.8 — Banking Details Form (official)
            </a>
            <span className="mx-2 text-gray-400">•</span>
            <a href="/uif/forms/UI-2.8.pdf" download className="text-pink-600 underline">Mirror download</a>
          </li>
          <li>
            <a href="https://www.labour.gov.za/DocumentCenter/Forms/Unemployment%20Insurance%20Fund/UI-2.1.pdf" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              UI-2.1 — Application for Unemployment Benefits (official)
            </a>
            <span className="mx-2 text-gray-400">•</span>
            <a href="/uif/forms/UI-2.1.pdf" download className="text-pink-600 underline">Mirror download</a>
          </li>
          <li>
            <a href="https://www.labour.gov.za/DocumentCenter/Forms/Unemployment%20Insurance%20Fund/UI-2.7.pdf" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              UI-2.7 — Employer Certificate (official)
            </a>
            <span className="mx-2 text-gray-400">•</span>
            <a href="/uif/forms/UI-2.7.pdf" download className="text-pink-600 underline">Mirror download</a>
          </li>
          <li>
            <a href="https://www.labour.gov.za/DocumentCenter/Forms/Unemployment%20Insurance%20Fund/UI-2.2.pdf" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              UI-2.2 — Remuneration Received while Unemployed (official)
            </a>
            <span className="mx-2 text-gray-400">•</span>
            <a href="/uif/forms/UI-2.2.pdf" download className="text-pink-600 underline">Mirror download</a>
          </li>
          <li>
            <a href="https://www.ufiling.labour.gov.za/uif/" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              Submit online via uFiling (official UIF portal)
            </a>
          </li>
          <li>
            <a href="https://www.labour.gov.za/Contacts/Provincial%20Offices" target="_blank" rel="noreferrer" className="text-pink-600 underline">
              Find your nearest Department of Labour Centre
            </a>
          </li>
        </ul>
      </div>

      <div className="text-xs text-gray-500 bg-gray-50 border rounded-xl p-3 leading-relaxed">
        <b>Disclaimer:</b> This calculator provides indicative results only. The Department of Employment and Labour and
        the Unemployment Insurance Fund (UIF) have final authority over claim approval, eligibility, rates and payouts.
        Mirrors are provided for convenience when official servers are unavailable.
      </div>
    </section>
  );
}
